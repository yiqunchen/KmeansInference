<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Application to single-cell RNA-seq data • KmeansInference</title>
<!-- jquery --><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js" integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo=" crossorigin="anonymous"></script><!-- Bootstrap --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/css/bootstrap.min.css" integrity="sha256-bZLfwXAP04zRMK2BjiO8iu9pf4FbLqX6zitd+tIvLhE=" crossorigin="anonymous">
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/js/bootstrap.min.js" integrity="sha256-nuL8/2cJ5NDSSwnKD8VqreErSWHtnEP9E7AySL+1ev4=" crossorigin="anonymous"></script><!-- bootstrap-toc --><link rel="stylesheet" href="../bootstrap-toc.css">
<script src="../bootstrap-toc.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet">
<script src="../pkgdown.js"></script><link href="../extra.css" rel="stylesheet">
<meta property="og:title" content="Application to single-cell RNA-seq data">
<meta property="og:description" content="KmeansInference">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body data-spy="scroll" data-target="#toc">
    

    <div class="container template-article">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../index.html">KmeansInference</a>
        <span class="version label label-default" data-toggle="tooltip" data-placement="bottom" title="">0.1.0</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="../articles/technical_details.html">Technical details</a>
</li>
<li>
  <a href="../articles/Tutorials.html">Software tutorials</a>
</li>
<li>
  <a href="../articles/real_data_example.html">Application to single-cell RNA-seq data</a>
</li>
<li>
  <a href="../reference/index.html">Reference</a>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right"></ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      

      </header><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header toc-ignore">
      <h1 data-toc-skip>Application to single-cell RNA-seq data</h1>
            
      
      
      <div class="hidden name"><code>real_data_example.Rmd</code></div>

    </div>

    
    
<p>In this tutorial, we illustrate how to apply the functions in the <code>KmeansInference</code> package to a single-cell RNA-seq dataset originally collected by Zheng et al. (2017), available <a href="https://www.10xgenomics.com/resources/datasets?menu%5Bproducts.name%5D=Single%20Cell%20Gene%20Expression&amp;query=zheng&amp;page=1&amp;configure%5Bfacets%5D%5B0%5D=chemistryVersionAndThroughput&amp;configure%5Bfacets%5D%5B1%5D=pipeline.version&amp;configure%5BhitsPerPage%5D=500." class="external-link">here</a> Single-cell RNA-seq quantifies gene expression abundance at the resolution of single cells, thereby revealing cell-to-cell heterogeneity in transcription and allowing for the identification of cell types and marker genes. In practice, biologists often cluster the cells to identify putative cell types, and then perform a differential expression analysis, i.e., they test for a difference in gene expression between two clusters (Grün et al., 2015, Lähnemann et al., 2020, Stuart et al., 2019). Because this approach ignores the fact that the clusters were estimated from the same data used for testing, it does not control the selective Type I error.</p>
<p>In this tutorial, we will make use of the data of the following five cell types: <a href="https://cf.10xgenomics.com/samples/cell-exp/1.1.0/cd14_monocytes/cd14_monocytes_filtered_gene_bc_matrices.tar.gz" class="external-link">monocytes</a>, <a href="https://cf.10xgenomics.com/samples/cell-exp/1.1.0/memory_t/memory_t_filtered_gene_bc_matrices.tar.gz" class="external-link">memory T cells</a>, <a href="https://cf.10xgenomics.com/samples/cell-exp/1.1.0/naive_t/naive_t_filtered_gene_bc_matrices.tar.gz" class="external-link">naive T cells</a>, <a href="https://cf.10xgenomics.com/samples/cell-exp/1.1.0/b_cells/b_cells_filtered_gene_bc_matrices.tar.gz" class="external-link">B cells</a>, and <a href="https://cf.10xgenomics.com/samples/cell-exp/1.1.0/cd56_nk/cd56_nk_filtered_gene_bc_matrices.tar.gz" class="external-link">natural killer cells</a>.</p>
<p>After downloading the data, you will need to need to rename the five downloaded folders as <code>filtered_matrices_mex_mono</code>, <code>filtered_matrices_mex_memory</code>, <code>filtered_matrices_mex_naive_cytotoxic</code>,<code>filtered_matrices_mex_bcell</code>, and <code>filtered_matrices_mex_nk</code>. The following analysis also assumes that all five folders are listed under the directory <code>raw</code>.</p>
<p>First we load the package and read in relevant data.</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="http://danifold.net/fastcluster.html" class="external-link">fastcluster</a></span><span class="op">)</span>
<span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va">DropletUtils</span><span class="op">)</span>
<span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="http://bioconductor.org/packages/scater/" class="external-link">scater</a></span><span class="op">)</span>
<span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/sinhrks/ggfortify" class="external-link">ggfortify</a></span><span class="op">)</span>
<span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://patchwork.data-imaginist.com" class="external-link">patchwork</a></span><span class="op">)</span>
<span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va">KmeansInference</span><span class="op">)</span>
<span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/tkonopka/umap" class="external-link">umap</a></span><span class="op">)</span>

<span class="va">consistent_color</span> <span class="op">&lt;-</span> <span class="fu">scales</span><span class="fu">::</span><span class="fu"><a href="https://scales.r-lib.org/reference/hue_pal.html" class="external-link">hue_pal</a></span><span class="op">(</span><span class="op">)</span><span class="op">(</span><span class="fl">8</span><span class="op">)</span>

<span class="co"># preprocessing function: credits to Lucy L. Gao at https://github.com/lucylgao/clusterpval-experiments/blob/master/real-data-code/util.R</span>

<span class="va">process_data</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">sce</span><span class="op">)</span> <span class="op">{</span>
  <span class="co"># Define mitochondrial, ribosomal protein genes</span>
  <span class="fu">rowData</span><span class="op">(</span><span class="va">sce</span><span class="op">)</span><span class="op">$</span><span class="va">Mito</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/grep.html" class="external-link">grepl</a></span><span class="op">(</span><span class="st">"^MT"</span>, <span class="fu">rowData</span><span class="op">(</span><span class="va">sce</span><span class="op">)</span><span class="op">$</span><span class="va">Symbol</span><span class="op">)</span>
  <span class="fu">rowData</span><span class="op">(</span><span class="va">sce</span><span class="op">)</span><span class="op">$</span><span class="va">ProteinRibo</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/grep.html" class="external-link">grepl</a></span><span class="op">(</span><span class="st">"^RP"</span>, <span class="fu">rowData</span><span class="op">(</span><span class="va">sce</span><span class="op">)</span><span class="op">$</span><span class="va">Symbol</span><span class="op">)</span>

  <span class="co"># Calculate quality statistics</span>
  <span class="va">sce</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/scater/man/addPerCellQC.html" class="external-link">addPerCellQC</a></span><span class="op">(</span><span class="va">sce</span>, subsets<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>mt<span class="op">=</span><span class="fu">rowData</span><span class="op">(</span><span class="va">sce</span><span class="op">)</span><span class="op">$</span><span class="va">Mito</span>, rbp<span class="op">=</span><span class="fu">rowData</span><span class="op">(</span><span class="va">sce</span><span class="op">)</span><span class="op">$</span><span class="va">ProteinRibo</span><span class="op">)</span><span class="op">)</span>
  <span class="va">sce</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/scater/man/addPerCellQC.html" class="external-link">addPerFeatureQC</a></span><span class="op">(</span><span class="va">sce</span><span class="op">)</span>

  <span class="co"># Delete bad cells (low library size, low gene count, high mitochondrial read proportion)</span>
  <span class="va">libsize.drop</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/scater/man/isOutlier.html" class="external-link">isOutlier</a></span><span class="op">(</span><span class="va">sce</span><span class="op">$</span><span class="va">sum</span>, nmads <span class="op">=</span> <span class="fl">3</span>, type <span class="op">=</span> <span class="st">"lower"</span>, log <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>
  <span class="va">feature.drop</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/scater/man/isOutlier.html" class="external-link">isOutlier</a></span><span class="op">(</span><span class="va">sce</span><span class="op">$</span><span class="va">detected</span>, nmads <span class="op">=</span> <span class="fl">3</span>, type <span class="op">=</span> <span class="st">"both"</span>, log <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>
  <span class="va">mito.drop</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/scater/man/isOutlier.html" class="external-link">isOutlier</a></span><span class="op">(</span><span class="va">sce</span><span class="op">$</span><span class="va">subsets_mt_percent</span>, nmads <span class="op">=</span> <span class="fl">3</span>, type <span class="op">=</span> <span class="st">"higher"</span>, log <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>
  <span class="va">sce</span> <span class="op">&lt;-</span> <span class="va">sce</span><span class="op">[</span>,<span class="op">!</span><span class="op">(</span><span class="va">libsize.drop</span> <span class="op">|</span> <span class="va">feature.drop</span> <span class="op">|</span><span class="va">mito.drop</span><span class="op">)</span><span class="op">]</span>

  <span class="co"># Normalize library sizes, then log2 transformation with pseudo-count of 1</span>
  <span class="va">sce</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/scater/man/logNormCounts.html" class="external-link">logNormCounts</a></span><span class="op">(</span><span class="va">sce</span><span class="op">)</span>

  <span class="co"># Subset to top 500 average count genes</span>
  <span class="va">X</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/t.html" class="external-link">t</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/SingleCellExperiment/man/assays.html" class="external-link">logcounts</a></span><span class="op">(</span><span class="va">sce</span><span class="op">)</span><span class="op">)</span>
  <span class="va">X</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/matrix.html" class="external-link">as.matrix</a></span><span class="op">(</span><span class="va">X</span><span class="op">)</span>
  <span class="va">X</span> <span class="op">&lt;-</span> <span class="va">X</span><span class="op">[</span>,  <span class="fu"><a href="https://rdrr.io/r/base/order.html" class="external-link">order</a></span><span class="op">(</span><span class="fu">rowData</span><span class="op">(</span><span class="va">sce</span><span class="op">)</span><span class="op">$</span><span class="va">mean</span>, decreasing<span class="op">=</span><span class="cn">T</span><span class="op">)</span><span class="op">[</span><span class="fl">1</span><span class="op">:</span><span class="fl">500</span><span class="op">]</span><span class="op">]</span>
  <span class="kw"><a href="https://rdrr.io/r/base/function.html" class="external-link">return</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>data<span class="op">=</span><span class="va">X</span>, labels<span class="op">=</span><span class="fu">colData</span><span class="op">(</span><span class="va">sce</span><span class="op">)</span><span class="op">$</span><span class="va">CellType</span><span class="op">)</span><span class="op">)</span>
<span class="op">}</span>

<span class="co"># estimator for sigma</span>
<span class="va">estimate_MED</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">X</span><span class="op">)</span><span class="op">{</span>
  <span class="kw">for</span> <span class="op">(</span><span class="va">j</span> <span class="kw">in</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">ncol</a></span><span class="op">(</span><span class="va">X</span><span class="op">)</span><span class="op">)</span><span class="op">)</span><span class="op">{</span>
    <span class="va">X</span><span class="op">[</span>,<span class="va">j</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="va">X</span><span class="op">[</span>,<span class="va">j</span><span class="op">]</span><span class="op">-</span><span class="fu"><a href="https://rdrr.io/r/stats/median.html" class="external-link">median</a></span><span class="op">(</span><span class="va">X</span><span class="op">[</span>,<span class="va">j</span><span class="op">]</span><span class="op">)</span><span class="op">}</span>
  <span class="va">sigma_hat</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/MathFun.html" class="external-link">sqrt</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/median.html" class="external-link">median</a></span><span class="op">(</span><span class="va">X</span><span class="op">^</span><span class="fl">2</span><span class="op">)</span><span class="op">/</span><span class="fu"><a href="https://rdrr.io/r/stats/Chisquare.html" class="external-link">qchisq</a></span><span class="op">(</span><span class="fl">1</span><span class="op">/</span><span class="fl">2</span>,df<span class="op">=</span><span class="fl">1</span><span class="op">)</span><span class="op">)</span>
  <span class="kw"><a href="https://rdrr.io/r/base/function.html" class="external-link">return</a></span><span class="op">(</span><span class="va">sigma_hat</span><span class="op">)</span>
<span class="op">}</span>

<span class="co">##### Pre-processing and splitting data ####</span>
<span class="va">cd4.t</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/DropletUtils/man/read10xCounts.html" class="external-link">read10xCounts</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="va">input_dir</span>,<span class="st">"./raw/filtered_matrices_mex_memory/hg19"</span><span class="op">)</span><span class="op">)</span>
<span class="va">cd19.b</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/DropletUtils/man/read10xCounts.html" class="external-link">read10xCounts</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="va">input_dir</span>, <span class="st">"./raw/filtered_matrices_mex_bcell/hg19"</span><span class="op">)</span><span class="op">)</span>
<span class="va">mono</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/DropletUtils/man/read10xCounts.html" class="external-link">read10xCounts</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="va">input_dir</span>, <span class="st">"./raw/filtered_matrices_mex_mono/hg19"</span><span class="op">)</span><span class="op">)</span>
<span class="va">nk</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/DropletUtils/man/read10xCounts.html" class="external-link">read10xCounts</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="va">input_dir</span>, <span class="st">"./raw/filtered_matrices_mex_nk/hg19/"</span><span class="op">)</span><span class="op">)</span>
<span class="va">naive.cytotoxic</span> <span class="op">&lt;-</span>  <span class="fu"><a href="https://rdrr.io/pkg/DropletUtils/man/read10xCounts.html" class="external-link">read10xCounts</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="va">input_dir</span>,<span class="st">"./raw/filtered_matrices_mex_naive_cytotoxic/hg19/"</span><span class="op">)</span><span class="op">)</span>

<span class="va">pure.t</span> <span class="op">&lt;-</span> <span class="va">cd4.t</span>
<span class="fu">colData</span><span class="op">(</span><span class="va">pure.t</span><span class="op">)</span><span class="op">$</span><span class="va">CellType</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="st">"Memory T cell"</span>, <span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">ncol</a></span><span class="op">(</span><span class="va">cd4.t</span><span class="op">)</span><span class="op">)</span><span class="op">)</span>

<span class="va">mix5</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/cbind.html" class="external-link">cbind</a></span><span class="op">(</span><span class="va">cd4.t</span>, <span class="va">cd19.b</span>, <span class="va">mono</span>, <span class="va">nk</span>, <span class="va">naive.cytotoxic</span><span class="op">)</span>
<span class="fu">colData</span><span class="op">(</span><span class="va">mix5</span><span class="op">)</span><span class="op">$</span><span class="va">CellType</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="st">"Memory T cell"</span>, <span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">ncol</a></span><span class="op">(</span><span class="va">cd4.t</span><span class="op">)</span><span class="op">)</span>,
                            <span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="st">"B cell"</span>, <span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">ncol</a></span><span class="op">(</span><span class="va">cd19.b</span><span class="op">)</span><span class="op">)</span>,
                            <span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="st">"Monocyte"</span>, <span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">ncol</a></span><span class="op">(</span><span class="va">mono</span><span class="op">)</span><span class="op">)</span>,
                            <span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="st">"Nature Killer"</span>, <span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">ncol</a></span><span class="op">(</span><span class="va">nk</span><span class="op">)</span><span class="op">)</span>,
                            <span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="st">"Naive Cytotoxic"</span>, <span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">ncol</a></span><span class="op">(</span><span class="va">naive.cytotoxic</span><span class="op">)</span><span class="op">)</span> <span class="op">)</span></code></pre></div>
<p>As in prior work (Gao et al. 2020, Duo et al. 2018), we first excluded cells with low numbers of expressed genes or total counts, as well as cells in which a large percentage of the expressed genes are mitochondrial. We then divide the counts for each cell by the total sum of counts in that cell. Finally, we applied a <span class="math inline">\(\log_2\)</span> transformation with a pseudo-count of 1 to the expression data, and considered only the subset of 1,000 genes with the largest average expression levels pre-normalization.</p>
<p>We applied this pre-processing pipeline separately to memory T cells (<span class="math inline">\(N=10,224\)</span>) and a mixture of five types of cells (memory T cells, B cells, naive cytotoxic T cells, natural killer cells, and monocytes; <span class="math inline">\(N=43,259\)</span>).</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/r/base/Random.html" class="external-link">set.seed</a></span><span class="op">(</span><span class="fl">1</span><span class="op">)</span>
<span class="va">processed.t</span> <span class="op">&lt;-</span> <span class="fu">process_data</span><span class="op">(</span><span class="va">pure.t</span><span class="op">)</span>
<span class="va">processed.mix5</span> <span class="op">&lt;-</span> <span class="fu">process_data</span><span class="op">(</span><span class="va">mix5</span><span class="op">)</span></code></pre></div>
<p>To investigate the selective Type I error in the absence of “true clusters”, we first constructed a “no cluster” dataset by randomly sampling 1,000 out of 10,224 memory T cells after pre-processing. Since the gene expression levels are highly correlated, we first whitened the data, i.e., we consider performing clustering and inference on <span class="math inline">\(\hat{\Sigma}^{-1/2}x_i\)</span> (as opposed to <span class="math inline">\(x_i\)</span>), where <span class="math inline">\(\hat{\mathbf{\Sigma}}^{-\frac{1}{2}} = \mathbf{U}(\mathbf{\Lambda}+0.01 \mathbf{I}_n)^{-\frac{1}{2}}\mathbf{U}^\top\)</span> and <span class="math inline">\(\mathbf{U}\mathbf{\Lambda}\mathbf{U}^\top\)</span> is the eigenvalue decomposition of the sample covariance matrix of <span class="math inline">\(x_1,\ldots, x_{1,000}\)</span>.</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">ss.id.null</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/sample.html" class="external-link">sample</a></span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">nrow</a></span><span class="op">(</span><span class="va">processed.t</span><span class="op">$</span><span class="va">data</span><span class="op">)</span>, <span class="fl">1000</span><span class="op">)</span>
<span class="va">X1</span> <span class="op">&lt;-</span> <span class="va">processed.t</span><span class="op">$</span><span class="va">data</span><span class="op">[</span><span class="va">ss.id.null</span>, <span class="op">]</span>
<span class="va">X1.ss</span> <span class="op">&lt;-</span> <span class="va">processed.t</span><span class="op">$</span><span class="va">data</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/sets.html" class="external-link">setdiff</a></span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">nrow</a></span><span class="op">(</span><span class="va">processed.t</span><span class="op">$</span><span class="va">data</span><span class="op">)</span>, <span class="va">ss.id.null</span><span class="op">)</span>, <span class="op">]</span>
<span class="va">eigen_cov_X</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/eigen.html" class="external-link">eigen</a></span><span class="op">(</span><span class="fu">coop</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/coop/man/covar.html" class="external-link">covar</a></span><span class="op">(</span><span class="va">X1</span><span class="op">)</span><span class="op">)</span>
<span class="va">U</span> <span class="op">&lt;-</span> <span class="va">eigen_cov_X</span><span class="op">$</span><span class="va">vectors</span>
<span class="va">D</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/diag.html" class="external-link">diag</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/MathFun.html" class="external-link">sqrt</a></span><span class="op">(</span><span class="fl">1</span><span class="op">/</span><span class="op">(</span><span class="va">eigen_cov_X</span><span class="op">$</span><span class="va">values</span><span class="op">+</span><span class="fl">0.01</span><span class="op">)</span><span class="op">)</span><span class="op">)</span>
<span class="va">X1_iso</span> <span class="op">&lt;-</span> <span class="va">X1</span><span class="op"><a href="https://rdrr.io/r/base/matmult.html" class="external-link">%*%</a></span><span class="fu"><a href="https://rdrr.io/r/base/t.html" class="external-link">t</a></span><span class="op">(</span><span class="va">U</span><span class="op">)</span><span class="op"><a href="https://rdrr.io/r/base/matmult.html" class="external-link">%*%</a></span><span class="va">D</span><span class="op"><a href="https://rdrr.io/r/base/matmult.html" class="external-link">%*%</a></span><span class="op">(</span><span class="va">U</span><span class="op">)</span></code></pre></div>
<p>We applied k-means clustering to the transformed data with <span class="math inline">\(K=5\)</span> (with 30 random initializations), and obtained five clusters consisting of 97, 223, 172, 165, and 343 cells, respectively. The resulting clusters are visualized using UMAP.</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/r/base/Random.html" class="external-link">set.seed</a></span><span class="op">(</span><span class="fl">1234</span><span class="op">)</span>
<span class="va">seed_list</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/sample.html" class="external-link">sample</a></span><span class="op">(</span><span class="fl">2021</span>,size<span class="op">=</span><span class="fl">30</span>,replace <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span>
<span class="va">k_means_list</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">lapply</a></span><span class="op">(</span><span class="va">seed_list</span>, <span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span><span class="fu"><a href="../reference/kmeans_estimation.html">kmeans_estimation</a></span><span class="op">(</span><span class="va">X1_iso</span>,
                                                               k<span class="op">=</span><span class="fl">5</span>,iter.max <span class="op">=</span> <span class="fl">30</span>,seed <span class="op">=</span> <span class="va">x</span><span class="op">)</span><span class="op">)</span>
<span class="va">within_ss_list</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">lapply</a></span><span class="op">(</span><span class="va">k_means_list</span>, <span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span><span class="va">x</span><span class="op">$</span><span class="va">objective</span><span class="op">[[</span><span class="va">x</span><span class="op">$</span><span class="va">iter</span><span class="op">]</span><span class="op">]</span><span class="op">)</span>
<span class="va">best_seed</span> <span class="op">&lt;-</span> <span class="va">seed_list</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/which.min.html" class="external-link">which.min</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/unlist.html" class="external-link">unlist</a></span><span class="op">(</span><span class="va">within_ss_list</span><span class="op">)</span><span class="op">)</span><span class="op">]</span>
<span class="va">current_kmeans_neg</span> <span class="op">&lt;-</span> <span class="va">k_means_list</span><span class="op">[[</span><span class="fu"><a href="https://rdrr.io/r/base/which.min.html" class="external-link">which.min</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/unlist.html" class="external-link">unlist</a></span><span class="op">(</span><span class="va">within_ss_list</span><span class="op">)</span><span class="op">)</span><span class="op">]</span><span class="op">]</span>
<span class="va">final_cluster_neg</span> <span class="op">&lt;-</span> <span class="va">current_kmeans_neg</span><span class="op">$</span><span class="va">cluster</span><span class="op">[[</span><span class="va">current_kmeans_neg</span><span class="op">$</span><span class="va">iter</span><span class="op">]</span><span class="op">]</span>
<span class="fu"><a href="https://rdrr.io/r/base/table.html" class="external-link">table</a></span><span class="op">(</span><span class="va">final_cluster_neg</span><span class="op">)</span>
<span class="co">#&gt; final_cluster_neg</span>
<span class="co">#&gt;   1   2   3   4   5 </span>
<span class="co">#&gt;  97 223 172 165 343</span>

<span class="fu"><a href="https://rdrr.io/r/base/Random.html" class="external-link">set.seed</a></span><span class="op">(</span><span class="fl">2021</span><span class="op">)</span>
<span class="va">X1_umap</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/umap/man/umap.html" class="external-link">umap</a></span><span class="op">(</span><span class="va">X1_iso</span><span class="op">)</span>
<span class="va">umap_data_x1</span> <span class="op">&lt;-</span> <span class="va">X1_umap</span><span class="op">$</span><span class="va">layout</span>
<span class="fu"><a href="https://rdrr.io/r/base/colnames.html" class="external-link">colnames</a></span><span class="op">(</span><span class="va">umap_data_x1</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"UMAP1"</span>,<span class="st">"UMAP2"</span><span class="op">)</span>

<span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span><span class="va">umap_data_x1</span>, <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>x<span class="op">=</span><span class="va">UMAP1</span>, y<span class="op">=</span><span class="va">UMAP2</span>,
                         colour<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/factor.html" class="external-link">as.factor</a></span><span class="op">(</span><span class="va">final_cluster_neg</span><span class="op">)</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_point.html" class="external-link">geom_point</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">ggtitle</a></span><span class="op">(</span><span class="st">"Memory T cells only"</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">ylab</a></span><span class="op">(</span><span class="st">"UMAP2"</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">xlab</a></span><span class="op">(</span><span class="st">"UMAP1"</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_brewer.html" class="external-link">scale_colour_brewer</a></span><span class="op">(</span>palette<span class="op">=</span><span class="st">"Dark2"</span>, name<span class="op">=</span><span class="st">"Estimated clusters"</span>,
                      guide<span class="op">=</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/guide_legend.html" class="external-link">guide_legend</a></span><span class="op">(</span>nrow<span class="op">=</span><span class="fl">2</span><span class="op">)</span><span class="op">)</span>  <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html" class="external-link">theme_bw</a></span><span class="op">(</span>base_size<span class="op">=</span><span class="fl">18</span><span class="op">)</span>  <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/theme.html" class="external-link">theme</a></span><span class="op">(</span>plot.title <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html" class="external-link">element_text</a></span><span class="op">(</span>hjust <span class="op">=</span> <span class="fl">0.5</span>,size<span class="op">=</span><span class="fl">18</span><span class="op">)</span>,
        legend.position<span class="op">=</span><span class="st">"bottom"</span>,
        <span class="co">#legend.title = element_text(size=18),</span>
        axis.text <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html" class="external-link">element_text</a></span><span class="op">(</span>size<span class="op">=</span><span class="fl">18</span><span class="op">)</span>,
        legend.text <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html" class="external-link">element_text</a></span><span class="op">(</span>size<span class="op">=</span><span class="fl">18</span>,hjust <span class="op">=</span> <span class="fl">0</span><span class="op">)</span>,
        axis.title<span class="op">=</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html" class="external-link">element_text</a></span><span class="op">(</span>size<span class="op">=</span><span class="fl">18</span><span class="op">)</span><span class="op">)</span></code></pre></div>
<p><img src="real_data_example_files/figure-html/unnamed-chunk-6-1.png" width="480"></p>
<p>In the code below, for demonstration purposes, we computed the p-values <span class="math inline">\(p_{\text{Naive}}\)</span> (which does not account for the fact that cluster memberships are estimated on the same data used for testing) and <span class="math inline">\(p_{\text{selective}}\)</span> (with estimated <span class="math inline">\(\hat\sigma\)</span>; see details in Section 4 of our paper). We see that the naive p-values are extremely small, while our proposed p-values are quite large. The complete results for all ten pairs of estimated cluster pairs, which can be found in Section 6 of our paper, yield the same trend. Because this dataset consists only of memory T cells, we believe that conclusion based on <span class="math inline">\(p_{\text{selective}}\)</span> aligns better with the underlying biology.</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">sig_hat_neg</span> <span class="op">&lt;-</span> <span class="fu">estimate_MED</span><span class="op">(</span><span class="va">X1_iso</span><span class="op">)</span>

<span class="va">neg_pval_1_2</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/kmeans_inference.html">kmeans_inference</a></span><span class="op">(</span>X<span class="op">=</span><span class="va">X1_iso</span>, k<span class="op">=</span><span class="fl">5</span>,
                                 cluster_1<span class="op">=</span><span class="fl">1</span>,
                                 cluster_2<span class="op">=</span><span class="fl">2</span>,
                                 sig <span class="op">=</span> <span class="va">sig_hat_neg</span>,
                                 iter.max <span class="op">=</span> <span class="fl">30</span>,
                                 seed <span class="op">=</span> <span class="va">best_seed</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/r/base/summary.html" class="external-link">summary</a></span><span class="op">(</span><span class="va">neg_pval_1_2</span><span class="op">)</span>
<span class="co">#&gt;   cluster_1 cluster_2 test_stat p_selective p_naive</span>
<span class="co">#&gt; 1         1         2   8.83438   0.3024664       0</span>

<span class="va">neg_pval_1_4</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/kmeans_inference.html">kmeans_inference</a></span><span class="op">(</span>X<span class="op">=</span><span class="va">X1_iso</span>, k<span class="op">=</span><span class="fl">5</span>,
                                 cluster_1<span class="op">=</span><span class="fl">1</span>,
                                 cluster_2<span class="op">=</span><span class="fl">4</span>,
                                 sig <span class="op">=</span> <span class="va">sig_hat_neg</span>,
                                 iter.max <span class="op">=</span> <span class="fl">30</span>,
                                 seed <span class="op">=</span> <span class="va">best_seed</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/r/base/summary.html" class="external-link">summary</a></span><span class="op">(</span><span class="va">neg_pval_1_4</span><span class="op">)</span>
<span class="co">#&gt;   cluster_1 cluster_2 test_stat p_selective p_naive</span>
<span class="co">#&gt; 1         1         4  12.36426   0.4320175       0</span></code></pre></div>
<p>In what follows, we consider a “cluster” dataset by randomly sampling 400 each of memory T cells, B cells, naive T cells, natural killer cells, and monocytes from the 43,259 cell mixture. After whitening the data (using the aforementioned transformation), we applied k-means clustering to obtain five clusters.</p>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">tcell.id</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/which.html" class="external-link">which</a></span><span class="op">(</span><span class="va">processed.mix5</span><span class="op">$</span><span class="va">labels</span> <span class="op">==</span> <span class="st">"Memory T cell"</span><span class="op">)</span>
<span class="va">bcell.id</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/which.html" class="external-link">which</a></span><span class="op">(</span><span class="va">processed.mix5</span><span class="op">$</span><span class="va">labels</span> <span class="op">==</span> <span class="st">"B cell"</span><span class="op">)</span>
<span class="va">mono.id</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/which.html" class="external-link">which</a></span><span class="op">(</span><span class="va">processed.mix5</span><span class="op">$</span><span class="va">labels</span> <span class="op">==</span> <span class="st">"Monocyte"</span><span class="op">)</span>
<span class="va">nk.id</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/which.html" class="external-link">which</a></span><span class="op">(</span><span class="va">processed.mix5</span><span class="op">$</span><span class="va">labels</span> <span class="op">==</span> <span class="st">"Nature Killer"</span><span class="op">)</span>
<span class="va">naive.id</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/which.html" class="external-link">which</a></span><span class="op">(</span><span class="va">processed.mix5</span><span class="op">$</span><span class="va">labels</span> <span class="op">==</span> <span class="st">"Naive Cytotoxic"</span><span class="op">)</span>

<span class="va">ss.id</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/sample.html" class="external-link">sample</a></span><span class="op">(</span><span class="va">tcell.id</span>, <span class="fl">400</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/sample.html" class="external-link">sample</a></span><span class="op">(</span><span class="va">bcell.id</span>, <span class="fl">400</span><span class="op">)</span>,
           <span class="fu"><a href="https://rdrr.io/r/base/sample.html" class="external-link">sample</a></span><span class="op">(</span><span class="va">mono.id</span>, <span class="fl">400</span><span class="op">)</span>,
           <span class="fu"><a href="https://rdrr.io/r/base/sample.html" class="external-link">sample</a></span><span class="op">(</span><span class="va">nk.id</span>, <span class="fl">400</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/sample.html" class="external-link">sample</a></span><span class="op">(</span><span class="va">naive.id</span>, <span class="fl">400</span><span class="op">)</span><span class="op">)</span>

<span class="va">X2</span> <span class="op">&lt;-</span> <span class="va">processed.mix5</span><span class="op">$</span><span class="va">data</span><span class="op">[</span><span class="va">ss.id</span>, <span class="op">]</span>
<span class="va">X2.ss</span> <span class="op">&lt;-</span> <span class="va">processed.mix5</span><span class="op">$</span><span class="va">data</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/sets.html" class="external-link">setdiff</a></span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">nrow</a></span><span class="op">(</span><span class="va">processed.mix5</span><span class="op">$</span><span class="va">data</span><span class="op">)</span>, <span class="va">ss.id</span><span class="op">)</span>, <span class="op">]</span>
<span class="co"># eigen-decomp -- whitening</span>
<span class="va">eigen_cov_X</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/eigen.html" class="external-link">eigen</a></span><span class="op">(</span><span class="fu">coop</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/coop/man/covar.html" class="external-link">covar</a></span><span class="op">(</span><span class="va">X2</span><span class="op">)</span><span class="op">)</span>
<span class="va">U</span> <span class="op">&lt;-</span> <span class="va">eigen_cov_X</span><span class="op">$</span><span class="va">vectors</span>
<span class="va">D</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/diag.html" class="external-link">diag</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/MathFun.html" class="external-link">sqrt</a></span><span class="op">(</span><span class="fl">1</span><span class="op">/</span><span class="op">(</span><span class="va">eigen_cov_X</span><span class="op">$</span><span class="va">values</span><span class="op">+</span><span class="fl">0.01</span><span class="op">)</span><span class="op">)</span><span class="op">)</span>
<span class="va">X2_iso</span> <span class="op">&lt;-</span> <span class="va">X2</span><span class="op"><a href="https://rdrr.io/r/base/matmult.html" class="external-link">%*%</a></span><span class="fu"><a href="https://rdrr.io/r/base/t.html" class="external-link">t</a></span><span class="op">(</span><span class="va">U</span><span class="op">)</span><span class="op"><a href="https://rdrr.io/r/base/matmult.html" class="external-link">%*%</a></span><span class="va">D</span><span class="op"><a href="https://rdrr.io/r/base/matmult.html" class="external-link">%*%</a></span><span class="op">(</span><span class="va">U</span><span class="op">)</span>

<span class="fu"><a href="https://rdrr.io/r/base/Random.html" class="external-link">set.seed</a></span><span class="op">(</span><span class="fl">2021</span><span class="op">)</span>
<span class="va">X2_umap</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/umap/man/umap.html" class="external-link">umap</a></span><span class="op">(</span><span class="va">X2_iso</span><span class="op">)</span>
<span class="va">umap_data_x2</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span><span class="va">X2_umap</span><span class="op">$</span><span class="va">layout</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/r/base/colnames.html" class="external-link">colnames</a></span><span class="op">(</span><span class="va">umap_data_x2</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"UMAP1"</span>,<span class="st">"UMAP2"</span><span class="op">)</span>
<span class="va">umap_data_x2</span><span class="op">$</span><span class="va">CellType</span> <span class="op">&lt;-</span> <span class="fu">colData</span><span class="op">(</span><span class="va">mix5</span><span class="op">)</span><span class="op">$</span><span class="va">CellType</span><span class="op">[</span><span class="va">ss.id</span><span class="op">]</span>

<span class="va">seed_list</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/sample.html" class="external-link">sample</a></span><span class="op">(</span><span class="fl">2021</span>,size<span class="op">=</span><span class="fl">30</span>,replace <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span>
<span class="va">k_means_list</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">lapply</a></span><span class="op">(</span><span class="va">seed_list</span>, <span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span>
  <span class="fu"><a href="../reference/kmeans_estimation.html">kmeans_estimation</a></span><span class="op">(</span><span class="va">X2_iso</span>,k<span class="op">=</span><span class="fl">5</span>,iter.max <span class="op">=</span> <span class="fl">20</span>,seed <span class="op">=</span> <span class="va">x</span><span class="op">)</span><span class="op">)</span>

<span class="va">within_ss_list</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">lapply</a></span><span class="op">(</span><span class="va">k_means_list</span>, <span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span><span class="va">x</span><span class="op">$</span><span class="va">objective</span><span class="op">[[</span><span class="va">x</span><span class="op">$</span><span class="va">iter</span><span class="op">]</span><span class="op">]</span><span class="op">)</span>
<span class="va">best_seed_pos</span> <span class="op">&lt;-</span> <span class="va">seed_list</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/which.min.html" class="external-link">which.min</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/unlist.html" class="external-link">unlist</a></span><span class="op">(</span><span class="va">within_ss_list</span><span class="op">)</span><span class="op">)</span><span class="op">]</span>
<span class="va">current_kmeans_pos</span> <span class="op">&lt;-</span> <span class="va">k_means_list</span><span class="op">[[</span><span class="fu"><a href="https://rdrr.io/r/base/which.min.html" class="external-link">which.min</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/unlist.html" class="external-link">unlist</a></span><span class="op">(</span><span class="va">within_ss_list</span><span class="op">)</span><span class="op">)</span><span class="op">]</span><span class="op">]</span>
<span class="va">final_cluster_pos</span> <span class="op">&lt;-</span> <span class="va">current_kmeans_pos</span><span class="op">$</span><span class="va">cluster</span><span class="op">[[</span><span class="va">current_kmeans_pos</span><span class="op">$</span><span class="va">iter</span><span class="op">]</span><span class="op">]</span>

<span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span><span class="va">umap_data_x2</span>, <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>x<span class="op">=</span><span class="va">UMAP1</span>, y<span class="op">=</span><span class="va">UMAP2</span>, colour<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/factor.html" class="external-link">as.factor</a></span><span class="op">(</span><span class="va">final_cluster_pos</span><span class="op">)</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_point.html" class="external-link">geom_point</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">ggtitle</a></span><span class="op">(</span><span class="st">"Mixture of five cell types"</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">xlab</a></span><span class="op">(</span><span class="st">"UMAP1"</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">ylab</a></span><span class="op">(</span><span class="st">"UMAP2"</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_brewer.html" class="external-link">scale_colour_brewer</a></span><span class="op">(</span>palette<span class="op">=</span><span class="st">"Dark2"</span>, name<span class="op">=</span><span class="st">"Estimated clusters"</span>,
                      guide<span class="op">=</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/guide_legend.html" class="external-link">guide_legend</a></span><span class="op">(</span>nrow<span class="op">=</span><span class="fl">2</span><span class="op">)</span><span class="op">)</span>  <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html" class="external-link">theme_bw</a></span><span class="op">(</span>base_size<span class="op">=</span><span class="fl">18</span><span class="op">)</span>  <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/theme.html" class="external-link">theme</a></span><span class="op">(</span>plot.title <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html" class="external-link">element_text</a></span><span class="op">(</span>hjust <span class="op">=</span> <span class="fl">0.5</span>,size<span class="op">=</span><span class="fl">18</span><span class="op">)</span>,
        legend.position<span class="op">=</span><span class="st">"bottom"</span>,
        axis.text <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html" class="external-link">element_text</a></span><span class="op">(</span>size<span class="op">=</span><span class="fl">18</span><span class="op">)</span>,
        legend.text <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html" class="external-link">element_text</a></span><span class="op">(</span>size<span class="op">=</span><span class="fl">18</span>,hjust <span class="op">=</span> <span class="fl">0</span><span class="op">)</span>,
        axis.title<span class="op">=</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html" class="external-link">element_text</a></span><span class="op">(</span>size<span class="op">=</span><span class="fl">18</span><span class="op">)</span><span class="op">)</span></code></pre></div>
<p><img src="real_data_example_files/figure-html/unnamed-chunk-8-1.png" width="480"></p>
<p>Comparing the estimated cluster membership with the “ground truth” cell types, we see that these clusters approximately correspond to the five different cell types (Cluster 1: 82.5% naive cytotoxic T cells; Cluster 2: 95.3% memory T cells; Cluster 3: 99.2% B cells; Cluster 4: 91.5% nature killer cells; Cluster 5: 83.3% monocytes).</p>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">adj_RI</span> <span class="op">&lt;-</span> <span class="fu">mclust</span><span class="fu">::</span><span class="fu"><a href="https://mclust-org.github.io/mclust/reference/adjustedRandIndex.html" class="external-link">adjustedRandIndex</a></span><span class="op">(</span><span class="va">final_cluster_pos</span>, <span class="va">umap_data_x2</span><span class="op">$</span><span class="va">CellType</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="st">"Adjusted Rand Index between the estimated clusters and the cell types is "</span>, <span class="va">adj_RI</span>, <span class="st">"\n"</span><span class="op">)</span>
<span class="co">#&gt; Adjusted Rand Index between the estimated clusters and the cell types is  0.7763105</span>
<span class="va">result_tab</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/table.html" class="external-link">table</a></span><span class="op">(</span><span class="va">final_cluster_pos</span>, <span class="va">umap_data_x2</span><span class="op">$</span><span class="va">CellType</span><span class="op">)</span>
<span class="va">result_tab</span><span class="op">/</span><span class="fu"><a href="https://rdrr.io/r/base/colSums.html" class="external-link">rowSums</a></span><span class="op">(</span><span class="va">result_tab</span><span class="op">)</span>
<span class="co">#&gt;                  </span>
<span class="co">#&gt; final_cluster_pos      B cell Memory T cell    Monocyte Naive Cytotoxic</span>
<span class="co">#&gt;                 1 0.987562189   0.007462687 0.000000000     0.002487562</span>
<span class="co">#&gt;                 2 0.000000000   0.000000000 0.070707071     0.000000000</span>
<span class="co">#&gt;                 3 0.000000000   0.979885057 0.008620690     0.008620690</span>
<span class="co">#&gt;                 4 0.183879093   0.000000000 0.816120907     0.000000000</span>
<span class="co">#&gt;                 5 0.000000000   0.129102845 0.000000000     0.814004376</span>
<span class="co">#&gt;                  </span>
<span class="co">#&gt; final_cluster_pos Nature Killer</span>
<span class="co">#&gt;                 1   0.002487562</span>
<span class="co">#&gt;                 2   0.929292929</span>
<span class="co">#&gt;                 3   0.002873563</span>
<span class="co">#&gt;                 4   0.000000000</span>
<span class="co">#&gt;                 5   0.056892779</span></code></pre></div>
<p>In the code below, we computed the p-values <span class="math inline">\(p_{\text{Naive}}\)</span> and <span class="math inline">\(p_{\text{selective}}\)</span> for two estimated pairs of clusters (full results can be found in Section 6 of our paper). Both sets of <span class="math inline">\(p\)</span>-values are extremely small on this dataset, which suggests that our <span class="math inline">\(p\)</span>-value has substantial power to reject the null hypothesis when it does not hold.</p>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">sig_hat_pos</span> <span class="op">&lt;-</span> <span class="fu">estimate_MED</span><span class="op">(</span><span class="va">X2_iso</span><span class="op">)</span>
<span class="va">pos_pval_1_2</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/kmeans_inference.html">kmeans_inference</a></span><span class="op">(</span>X<span class="op">=</span><span class="va">X2_iso</span>, k<span class="op">=</span><span class="fl">5</span>,
                                 cluster_1<span class="op">=</span><span class="fl">1</span>,
                                 cluster_2<span class="op">=</span><span class="fl">2</span>,
                                 sig <span class="op">=</span> <span class="va">sig_hat_pos</span>,
                                 iter.max <span class="op">=</span> <span class="fl">20</span>,
                                 seed <span class="op">=</span> <span class="va">best_seed_pos</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/r/base/summary.html" class="external-link">summary</a></span><span class="op">(</span><span class="va">pos_pval_1_2</span><span class="op">)</span>
<span class="co">#&gt;   cluster_1 cluster_2 test_stat   p_selective p_naive</span>
<span class="co">#&gt; 1         1         2  26.43431 9.547757e-155       0</span>

<span class="va">pos_pval_1_3</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/kmeans_inference.html">kmeans_inference</a></span><span class="op">(</span>X<span class="op">=</span><span class="va">X2_iso</span>, k<span class="op">=</span><span class="fl">5</span>,
                                 cluster_1<span class="op">=</span><span class="fl">1</span>,
                                 cluster_2<span class="op">=</span><span class="fl">3</span>,
                                 sig <span class="op">=</span> <span class="va">sig_hat_pos</span>,
                                 iter.max <span class="op">=</span> <span class="fl">20</span>,
                                 seed <span class="op">=</span> <span class="va">best_seed_pos</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/r/base/summary.html" class="external-link">summary</a></span><span class="op">(</span><span class="va">pos_pval_1_3</span><span class="op">)</span>
<span class="co">#&gt;   cluster_1 cluster_2 test_stat  p_selective p_naive</span>
<span class="co">#&gt; 1         1         3  19.09216 2.039673e-15       0</span></code></pre></div>
<div class="section level3">
<h3 id="references">References<a class="anchor" aria-label="anchor" href="#references"></a>
</h3>
<p>Chen YT and Witten DM. (2022+) Selective inference for <span class="math inline">\(k\)</span>-means clustering. arXiv preprint. <a href="https://arxiv.org/abs/2203.15267" class="external-link uri">https://arxiv.org/abs/2203.15267</a>.</p>
<p>Duò, A., Robinson, M. D., and Soneson, C. (2018). A systematic performance evaluation of clustering methods for single-cell RNA-seq data. F1000Research, 7:1141.</p>
<p>Gao, L. L., Bien, J., and Witten, D. (2020). Selective inference for hierarchical clustering. arXiv preprint. arXiv:2012.02936.</p>
<p>Lähnemann, D., Köster, J., Szczurek, E., et al. (2020). Eleven grand challenges in single-cell data science. Genome Biology, 21(1):31.</p>
<p>Stuart, T., Butler, A., Hoffman, P., et al. (2019). Comprehensive integration of Single-Cell data. Cell, 177(7):1888–1902.e21.</p>
<p>Zheng, G. X. Y., Terry, J. M., Belgrader, P., Ryvkin, P., Bent, Z. W., Wilson, R., Ziraldo, S. B., Wheeler, T. D., McDermott, G. P., Zhu, J., Gregory, M. T., Shuga, J., Montesclaros, L., Underwood, J. G., Masquelier, D. A., Nishimura, S. Y., Schnall-Levin, M., Wyatt, P. W., Hindson, C. M., Bharadwaj, R., Wong, A., Ness, K. D., Beppu, L. W., Deeg, H. J., McFarland, C., Loeb, K. R., Valente, W. J., Ericson, N. G., Stevens, E. A., Radich, J. P., Mikkelsen, T. S., Hindson, B. J., and Bielas, J. H. (2017), “Massively parallel digital transcriptional profiling of single cells,” Nature Communications, 8, 14049. <a href="https://doi.org/10.1038/ncomms14049" class="external-link uri">https://doi.org/10.1038/ncomms14049</a>.</p>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="pkgdown-sidebar">

      </div>

</div>



      <footer><div class="copyright">
  <p></p>
<p>Developed by Yiqun Chen.</p>
</div>

<div class="pkgdown">
  <p></p>
<p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.0.2.9000.</p>
</div>

      </footer>
</div>

  


  

  </body>
</html>
